{% load static %}
<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>GestiÃ³n de Usuarios</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <style>
      body {
        background: linear-gradient(135deg, #ff6600 0%, #00aaff 100%);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        min-height: 100vh;
        padding: 40px;
      }
      .table-container {
        margin: 2rem auto;
        max-width: 900px;
        background-color: white;
        border-radius: 12px;
        box-shadow: 0 3px 15px rgba(0, 0, 0, 0.2);
        padding: 2rem;
        ax-height: 550px;  
        overflow-y: auto; 
      }
      .table td.clave-col {
        max-width: 200px; 
        white-space: nowrap; 
        overflow: hidden; 
        text-overflow: ellipsis;
        font-size: 0.85rem; 
      }
      h2 {
        margin-bottom: 1.5rem;
        font-weight: 700;
        text-align: center;
        color: #f57c00; /* mismo naranja */
      }
      thead {
        background-color: #f5f5f5;
        color: #333;
      }
      tbody tr:hover {
        background-color: #fff3e0;
      }
      .btn-accion {
        margin-right: 5px;
      }
      .btn-agregar {
        background-color: #4caf50;
        color: white;
        font-weight: 600;
      }
      .btn-agregar:hover {
        background-color: #388e3c;
      }
      .btn-editar {
        background-color: #4caf50;
        color: white;
      }
      .btn-eliminar {
        background-color: #d32f2f;
        color: white;
      }
      .volver-inicio {
        margin-top: 20px;
        background-color: #000;
        color: white;
        font-weight: 600;
        border: none;
        padding: 10px 20px;
        border-radius: 6px;
        display: block;
        text-align: center;
        text-decoration: none;
      }
      .volver-inicio:hover {
        background-color: #333;
        color: white;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body>
    <div class="table-container">
      <h2>ğŸ“‹ Lista de Usuarios</h2>

      <!-- Botones de AcciÃ³n -->
      <div class="mb-3 text-end">
        <a href="{% url 'crear_usuario' %}" class="btn-agregar">â• Agregar Usuario</a>
        <a href="{% url 'audit_logs' %}" class="btn-agregar">ğŸ“‹ Ver Historial de Cambios</a>
      </div>

      <!-- Tabla Usuarios -->
      <table class="table table-striped table-bordered text-center align-middle">
        <thead>
          <tr>
            <th>ğŸ‘¤ Usuario</th>
            <th>ğŸ”‘ Clave</th>
            <th>ğŸ›¡ï¸ Rol</th>
            <th>ğŸ“Œ Estado</th>
            <th>âš™ï¸ Acciones</th>
          </tr>
        </thead>
        
        <tbody>
          {% for u in usuarios %}
          <tr class="{% if u.estado != 'A' %}inactive-row{% endif %}">
            <td>{{ u.usuario }}</td>
            <td class="clave-col">{{ u.clave }}</td>
            <td>{{ u.rol }}</td>

            <!-- Estado visible -->
            <td>
              {% if u.estado == 'A' %}
              <span class="badge bg-success">Activo</span>
              {% else %}
              <span class="badge bg-secondary">Inactivo</span>
              {% endif %}
            </td>

            <!-- Acciones (orden: alta/baja â†’ editar â†’ eliminar) -->
            <td class="text-center">
              <!-- Alta/Baja -->
              <form action="{% url 'permisos' u.id %}" method="post" class="d-inline">
                {% csrf_token %}
                <input type="hidden" name="next" value="{{ request.get_full_path }}"/>

                {% if u.estado == 'A' %}
                  <button type="submit" class="btn btn-warning btn-sm">â¬‡ï¸ Dar de baja</button>
                {% else %}
                  <button type="submit" class="btn btn-primary btn-sm">â¬†ï¸ Dar de alta</button>
                {% endif %}
              </form>

              <!-- Editar: deshabilitar si estÃ¡ inactivo -->
              {% if u.estado == 'A' %}
                <a href="{% url 'actualizar_usuario' u.id %}" class="btn btn-success btn-sm">âœï¸ Editar</a>
              {% else %}
                <button type="button" class="btn btn-success btn-sm" disabled>âœï¸ Editar</button>
              {% endif %}

              <!-- Eliminar usuario -->
              {% if request.session.rol == 'Administrador' or request.session.is_superadmin %}
                {% if request.session.is_superadmin %}
                  {% if u.estado == 'A' %}
                    <button type="button" class="btn btn-danger btn-sm" onclick="confirmarEliminacion({{ u.id }})">ğŸ—‘ï¸ Eliminar</button>
                  {% else %}
                    <button type="button" class="btn btn-danger btn-sm" disabled>ğŸ—‘ï¸ Eliminar</button>
                  {% endif %}
                {% else %}
                  <!-- Si es solo Administrador -->
                  <button type="button" class="btn btn-danger btn-sm" disabled title="Solo el superadministrador puede eliminar">ğŸ—‘ï¸ Eliminar</button>
                {% endif %}
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted">
              âš ï¸ No hay usuarios registrados aÃºn
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <!-- PaginaciÃ³n -->
      {% if usuarios.has_other_pages %}
      <nav aria-label="Page navigation" class="mt-3">
        <ul class="pagination justify-content-center">

          <!-- BotÃ³n Anterior -->
          {% if usuarios.has_previous %}
          <li class="page-item">
            <a class="page-link" href="?page={{ usuarios.previous_page_number }}" aria-label="Anterior">
              &laquo;
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          <!-- NÃºmeros de pÃ¡gina -->
          {% for num in usuarios.paginator.page_range %}
            {% if usuarios.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > usuarios.number|add:'-3' and num < usuarios.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          <!-- BotÃ³n Siguiente -->
          {% if usuarios.has_next %}
          <li class="page-item">
            <a class="page-link" href="?page={{ usuarios.next_page_number }}" aria-label="Siguiente">
              &raquo;
            </a>
          </li>
          {% else %}
          <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
      {% endif %}

      <!-- BotÃ³n volver -->
      <a href="{% url 'home' %}" class="volver-inicio">â‡¦ Volver al Inicio</a>
    </div>
  </body>

  <script>
    function confirmarEliminacion(usuarioId) {
      Swal.fire({
        title: "Â¿EstÃ¡ seguro?",
        text: "Este usuario serÃ¡ eliminado permanentemente",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "SÃ­, eliminar",
        cancelButtonText: "Cancelar",
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/usuarios/${usuarioId}/eliminar/`;
        }
      });
    }
  </script>
</html>
